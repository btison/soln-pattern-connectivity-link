= Solution Pattern: App Connectivity with Policy-as-Code
:sectnums:
:sectlinks:
:doctype: book

= See the Solution in Action

== Run the demonstration

=== Before getting started
To run this demo, you will need:

* You will need an OpenShift cluster with admin access
* Access to AWS to be able to create Route53 domain names
* Free tier of Redis database

= Walkthrough guide
== Setup Prerequisite:

=== Create Managed Zone on AWS

Refer: https://developers.redhat.com/articles/2024/06/12/getting-started-red-hat-connectivity-link-openshift#prerequisites[Prerequisites on Red Hat Developers^]

* In AWS Route53 add a hosted zone as a subdomain (for example, managed.mytopdomain.com) for the applications that you want to manage and secure with Connectivity Link.
* Refer to the the https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/hosted-zones-working-with.html[AWS documentation^] on Route53 for instructions on how to setup the hosted zone.
* Make sure you will have to create NS records in the top domain hosted zone in order to be able to route traffic to the subdomain, as explained in https://repost.aws/knowledge-center/create-subdomain-route-53[this article^].

== Redis

* You can sign up for a free tier of Redis Cloud. Sign up at https://app.redislabs.com/[app.redislabs.com^]
* Once a free DB is created, get the connection string.
** Click on DB created, and click on Connect button show in the page
+
image::redis-connection.png.png[width=40%]
* You will need only the connection string which will look like this
+
`redis://default:qwertyqwertyqwerty@redis-12345678.c1000.eu-central-1-1.ec2.redns.redis-cloud.com:10155`

== Deploy the RHCL Operator and related Kuadrant system

* Clone the ansible script
+
----
git clone https://github.com/rh-soln-pattern-connectivity-link/cl-install-ansible
----
* Open the inventories/inventory.template file and update the following variables. Save the file.
+
```
ocp4_workload_connectivity_link_kuadrant_redis_url=<redis URL you setup in the previous step>
# E.g.: redis://default:qwertyqwertyqwerty@redis-12345678.c1000.eu-central-1-1.ec2.redns.redis-cloud.com:10155

ocp4_workload_connectivity_link_aws_access_key=<AWS_ACCESS_KEY_ID>
ocp4_workload_connectivity_link_aws_secret_access_key=<AWS_SECRET_ACCESS_KEY>

ocp4_workload_connectivity_link_aws_managed_zone_id=<Managed Zone ID - created in the previous step>
# E.g.: Z12345677XYZ0FF0GBHIJ0

ocp4_workload_connectivity_link_aws_managed_zone_domain=<Managed Zone domain - created in the previous step>
# E.g.: managed.sandbox1585.opentlc.com

ocp4_workload_connectivity_link_aws_managed_zone_region=<Managed Zone region - default region of your AWS setup>
# E.g.: eu-central-1

ocp4_workload_connectivity_link_ingress_gateway_tls_issuer_email=<your  address email for letsencrypt>

ocp4_workload_connectivity_link_gateway_geo_code=<gateway geo code>
# E.g.: EU or US
```
* Run the Ansible script which will setup the RHCL Operator, Istio and Kuadrant system workloads
----
ansible-playbook playbooks/ocp4_workload_connectivity_link.yml  -e ACTION=create -i inventories/inventory.template
----

== Deploy the Globex application

* Git clone the repo with the ansible script
---- 
git clone https://github.com/rh-soln-pattern-connectivity-link/globex-ansible.git
----
* Open the inventories/inventory.template file and update the following variables. Save the file.
+
```
ocp4_workload_cloud_architecture_workshop_mobile_gateway_url=https://globex-mobile.<aws_managed_zone_domain>

#E.g.: https://globex-mobile.managed.sandbox2662.opentlc.com
```
* 
Run the Ansible script which will setup the Globex app.
+
----
ansible-playbook playbooks/globex.yml -e ACTION=create -i inventories/inventory.template
----

== Deployment Walkthrough

So far you have setup (note that all this is setup by the Infra persona)

* GatewayAPI with Istio has the provider
* RHCL Operator
* Various policies and CRDs including
** ManagedZone
** Gateway (ingress-gateway namespace)
** DNS Policy (ingress-gateway namespace)
** TLS Policy (default policy in ingress-gateway namespace)
** Auth Policy (deny-all default policy in ingress-gateway namespace)
** RateLimit Policy (default policy in ingress-gateway namespace)

The Gateway is now ready for developers to use for connect to their service endpoints.

== Setup service-endpoints as a Developer

=== Test Globex Mobile

* Acess the Globex Mobile's Route from the *globex-apim-user1* namespace > Routes
* Login using `asilva/openshift` credentials
* Click on Categories - you should see a 404. This is because the HTTPRoute hasn't been created yet



=== Set up HTTPRoute and backend

* Copy the following into the *Import YAML* utility accessible by the (+) button on top of the OpenShift Console
* Make changes to the elements marked as << REPLACE >>.
* In this YAML replae the the s`pec > hostnames` as show below

----
kind: HTTPRoute
apiVersion: gateway.networking.k8s.io/v1beta1
metadata:
  name: globex-mobile-gateway
  namespace: globex-apim-user1
  labels:
    deployment: globex-mobile-gateway
    service: globex-mobile-gateway
spec:
  parentRefs:
    - kind: Gateway
      namespace: ingress-gateway
      name: prod-web
  hostnames:
    - globex-mobile.<<REPLACE WITH YOUR MANAGED ZONE . E.g. managed.sandbox1585.opentlc.com>>
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: "/mobile/services/product/category/"
          method: GET
      backendRefs:
        - name: globex-mobile-gateway
          namespace: globex-apim-user1
          port: 8080
    - matches:
        - path:
            type: Exact
            value: "/mobile/services/category/list"
          method: GET
      backendRefs:
        - name: globex-mobile-gateway
          namespace: globex-apim-user1
          port: 8080
----

=== Test Globex Mobile again (after HTTPRoute is setup)

* Try accessing *Categories* again - you should see a 403.
* This is because while you have the HTTPRoute now, the original deny-all default policy kicks in and doesnâ€™t allow any calls

=== Setup Authpolicy

* Copy the following into the *Import YAML* utility accessible by the (+) button on top of the OpenShift Console
* Make changes to the elements marked as << REPLACE >>.
* In this YAML replae the the s`pec > hostnames` as show below

----
apiVersion: kuadrant.io/v1beta2
kind: AuthPolicy
metadata:
  name: globex-mobile-gateway
  namespace: globex-apim-user1
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: globex-mobile-gateway
    namespace: globex-apim-user1
  rules:
    authentication:
      "keycloak-users":
        jwt:
          issuerUrl: https://sso.apps.<<REPLACE WITH OPENSHIFT DOMAIN e.g. rhcl.sandbox123.opentlc.com>>/realms/globex-user1
    response:
      success:
        dynamicMetadata:
          identity:
            json:
              properties:
                userid:
                  selector: auth.identity.sub
  routeSelectors:
    - matches: []
----

=== Test Globex Mobile again (after HTTPRoute and AuthPolicy are setup)

* Try accessing *Categories* again - you should now be able to see the Categories

=== Setup RateLimit Policy

* Copy the following into the *Import YAML* utility accessible by the (+) button on top of the OpenShift Console

----
apiVersion: kuadrant.io/v1beta2
kind: RateLimitPolicy
metadata:
  name: globex-mobile-gateway
  namespace: globex-apim-user1
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: globex-mobile-gateway
    namespace: globex-apim-user1
  limits:
    "per-user":
      rates:
        - limit: 5
          duration: 10
          unit: second
      counters:
        - metadata.filter_metadata.envoy\.filters\.http\.ext_authz.identity.userid
----


=== Test Globex Mobile again (after HTTPRoute, AuthPolicy and RateLimitPolicy are setup)

* Try accessing *Categories* again - you should now be able to see the Categories
* Click any of the Categories from the list, and then the *Categories* menu, and repeat this a few times
* You would see a 429 error
